---
interface Props {
  username: string;
}

const { username } = Astro.props;

let repos = [];
let totalStars = 0;
let mostStarredRepo = { name: "", stars: 0 };
let mostActiveRepo = { name: "", lastPush: "" };
let error = false;

try {
  const response = await fetch(`https://api.github.com/users/${username}/repos?per_page=100&sort=updated`, {
    headers: {
      'User-Agent': 'Mozilla/5.0'
    }
  });

  if (!response.ok) throw new Error("Failed to fetch repos");

  repos = await response.json();

  if (repos.length > 0) {
    // Calculate Total Stars
    totalStars = repos.reduce((acc: number, repo: any) => acc + repo.stargazers_count, 0);

    // Find Most Starred Repo
    const sortedByStars = [...repos].sort((a, b) => b.stargazers_count - a.stargazers_count);
    mostStarredRepo = {
      name: sortedByStars[0].name,
      stars: sortedByStars[0].stargazers_count
    };

    // Find Most Active Repo (based on last update)
    const sortedByUpdate = [...repos].sort((a, b) => new Date(b.pushed_at).getTime() - new Date(a.pushed_at).getTime());
    mostActiveRepo = {
      name: sortedByUpdate[0].name,
      lastPush: new Date(sortedByUpdate[0].pushed_at).toLocaleDateString('en-US', { 
        month: 'short', 
        day: 'numeric', 
        year: 'numeric' 
      })
    };
  }
} catch (e) {
  console.error("GitHub Stats Detail Error:", e);
  error = true;
}
---

<div class="github-stats-detail w-full max-w-5xl mx-auto mt-6">
  <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
    {error ? (
      <div class="col-span-full py-4 text-center opacity-50 text-xs">Unable to load deep stats</div>
    ) : (
      <>
        <!-- Total Stars -->
        <div class="stat-card bg-white/5 dark:bg-black/20 backdrop-blur-md border border-black/10 dark:border-white/5 p-5 rounded-lg group hover:bg-white/10 dark:hover:bg-white/5 transition-all duration-500">
          <div class="flex items-center gap-3 mb-2">
            <div class="size-8 rounded-full bg-yellow-500/10 flex items-center justify-center text-yellow-500">
              <svg viewBox="0 0 24 24" class="size-4 fill-current"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>
            </div>
            <h3 class="text-[10px] font-bold uppercase tracking-[0.2em] opacity-30 group-hover:opacity-50 transition-opacity">Total Stars</h3>
          </div>
          <div class="text-2xl font-bold text-black dark:text-white tabular-nums">
             {totalStars}
          </div>
        </div>

        <!-- Most Starred -->
        <div class="stat-card bg-white/5 dark:bg-black/20 backdrop-blur-md border border-black/10 dark:border-white/5 p-5 rounded-lg group hover:bg-white/10 dark:hover:bg-white/5 transition-all duration-500">
           <div class="flex items-center gap-3 mb-2">
            <div class="size-8 rounded-full bg-blue-500/10 flex items-center justify-center text-blue-500">
              <svg viewBox="0 0 24 24" class="size-4 fill-current"><path d="M3.5 18.49l6-6.01 4 4L22 6.92l-1.41-1.41-7.09 7.09-4-4L2 17.09l1.5 1.4z"/></svg>
            </div>
            <h3 class="text-[10px] font-bold uppercase tracking-[0.2em] opacity-30 group-hover:opacity-50 transition-opacity">Most Starred</h3>
          </div>
          <div class="text-sm font-bold text-black dark:text-white truncate" title={mostStarredRepo.name}>
             {mostStarredRepo.name}
          </div>
          <div class="text-[10px] opacity-40 font-medium">{mostStarredRepo.stars} Stars</div>
        </div>

        <!-- Most Active -->
        <div class="stat-card bg-white/5 dark:bg-black/20 backdrop-blur-md border border-black/10 dark:border-white/5 p-5 rounded-lg group hover:bg-white/10 dark:hover:bg-white/5 transition-all duration-500">
           <div class="flex items-center gap-3 mb-2">
            <div class="size-8 rounded-full bg-green-500/10 flex items-center justify-center text-green-500">
              <svg viewBox="0 0 24 24" class="size-4 fill-current"><path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8z"/><path d="M12.5 7H11v6l5.25 3.15.75-1.23-4.5-2.67z"/></svg>
            </div>
            <h3 class="text-[10px] font-bold uppercase tracking-[0.2em] opacity-30 group-hover:opacity-50 transition-opacity">Most Active</h3>
          </div>
          <div class="text-sm font-bold text-black dark:text-white truncate" title={mostActiveRepo.name}>
             {mostActiveRepo.name}
          </div>
          <div class="text-[10px] opacity-40 font-medium">Updated {mostActiveRepo.lastPush}</div>
        </div>
      </>
    )}
  </div>
</div>

<style>
 .stat-card {
    transition: all 0.6s cubic-bezier(0.16, 1, 0.3, 1);
  }
  .stat-card:hover {
    transform: translateY(-2px);
  }
</style>
